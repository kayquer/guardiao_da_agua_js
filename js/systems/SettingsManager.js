/**
 * GUARDI√ÉO DA √ÅGUA - SETTINGS MANAGER
 * Sistema de configura√ß√µes e prefer√™ncias do jogo
 */

class SettingsManager {
    constructor() {
        console.log('‚öôÔ∏è Inicializando SettingsManager...');
        
        // Configura√ß√µes padr√£o
        this.defaultSettings = {
            audio: {
                masterVolume: 80,
                musicVolume: 70,
                sfxVolume: 90
            },
            graphics: {
                quality: 'medium',
                antialiasing: true,
                shadows: true
            },
            gameplay: {
                difficulty: 'normal',
                autoSave: true,
                tutorialHints: true
            },
            controls: {
                cameraSensitivity: 1.0,
                zoomSpeed: 1.0
            }
        };
        
        // Configura√ß√µes atuais
        this.settings = { ...this.defaultSettings };
        
        // Elementos da UI
        this.settingsScreen = document.getElementById('settings-screen');
        this.closeBtn = document.getElementById('btn-close-settings');
        this.saveBtn = document.getElementById('btn-save-settings');
        this.resetBtn = document.getElementById('btn-reset-settings');
        
        // Carregar configura√ß√µes salvas
        this.loadSettings();
        
        // Configurar event listeners
        this.setupEventListeners();
        
        console.log('‚úÖ SettingsManager inicializado');
    }
    
    // ===== INICIALIZA√á√ÉO =====
    setupEventListeners() {
        // Bot√µes principais
        if (this.closeBtn) {
            this.closeBtn.addEventListener('click', () => this.closeSettings());
        }
        
        if (this.saveBtn) {
            this.saveBtn.addEventListener('click', () => this.saveSettings());
        }
        
        if (this.resetBtn) {
            this.resetBtn.addEventListener('click', () => this.resetToDefaults());
        }
        
        // Controles de √°udio
        this.setupVolumeControls();
        
        // Controles de gr√°ficos
        this.setupGraphicsControls();
        
        // Controles de gameplay
        this.setupGameplayControls();
        
        // Controles de c√¢mera
        this.setupControlsSettings();
        
        // Tecla ESC para fechar
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape' && this.isSettingsOpen()) {
                this.closeSettings();
            }
        });
    }
    
    setupVolumeControls() {
        // Volume geral
        const masterVolume = document.getElementById('master-volume');
        const masterVolumeValue = document.getElementById('master-volume-value');
        if (masterVolume && masterVolumeValue) {
            masterVolume.addEventListener('input', (e) => {
                const value = parseInt(e.target.value);
                masterVolumeValue.textContent = `${value}%`;
                this.settings.audio.masterVolume = value;
                console.log('üîä Volume geral alterado para:', value);
                this.applyAudioSettings();
            });
        }

        // Volume da m√∫sica
        const musicVolume = document.getElementById('music-volume');
        const musicVolumeValue = document.getElementById('music-volume-value');
        if (musicVolume && musicVolumeValue) {
            musicVolume.addEventListener('input', (e) => {
                const value = parseInt(e.target.value);
                musicVolumeValue.textContent = `${value}%`;
                this.settings.audio.musicVolume = value;
                console.log('üéµ Volume da m√∫sica alterado para:', value);
                this.applyAudioSettings();
            });
        }

        // Volume dos efeitos
        const sfxVolume = document.getElementById('sfx-volume');
        const sfxVolumeValue = document.getElementById('sfx-volume-value');
        if (sfxVolume && sfxVolumeValue) {
            sfxVolume.addEventListener('input', (e) => {
                const value = parseInt(e.target.value);
                sfxVolumeValue.textContent = `${value}%`;
                this.settings.audio.sfxVolume = value;
                console.log('üîä Volume dos efeitos alterado para:', value);
                this.applyAudioSettings();
            });
        }
    }
    
    setupGraphicsControls() {
        // Qualidade gr√°fica
        const graphicsQuality = document.getElementById('graphics-quality');
        if (graphicsQuality) {
            graphicsQuality.addEventListener('change', (e) => {
                this.settings.graphics.quality = e.target.value;
                console.log('üé® Qualidade gr√°fica alterada para:', e.target.value);
                this.applyGraphicsSettings();
            });
        }

        // Anti-aliasing
        const antialiasing = document.getElementById('antialiasing');
        if (antialiasing) {
            antialiasing.addEventListener('change', (e) => {
                this.settings.graphics.antialiasing = e.target.checked;
                console.log('üé® Anti-aliasing alterado para:', e.target.checked);
                this.applyGraphicsSettings();
            });
        }

        // Sombras
        const shadows = document.getElementById('shadows');
        if (shadows) {
            shadows.addEventListener('change', (e) => {
                this.settings.graphics.shadows = e.target.checked;
                console.log('üåë Sombras alteradas para:', e.target.checked);
                this.applyGraphicsSettings();
            });
        }
    }
    
    setupGameplayControls() {
        // Dificuldade
        const difficulty = document.getElementById('difficulty');
        if (difficulty) {
            difficulty.addEventListener('change', (e) => {
                this.settings.gameplay.difficulty = e.target.value;
                console.log('üéÆ Dificuldade alterada para:', e.target.value);
                this.applyGameplaySettings();
            });
        }

        // Auto-save
        const autoSave = document.getElementById('auto-save');
        if (autoSave) {
            autoSave.addEventListener('change', (e) => {
                this.settings.gameplay.autoSave = e.target.checked;
                console.log('üíæ Auto-save alterado para:', e.target.checked);
                this.applyGameplaySettings();
            });
        }

        // Dicas do tutorial
        const tutorialHints = document.getElementById('tutorial-hints');
        if (tutorialHints) {
            tutorialHints.addEventListener('change', (e) => {
                this.settings.gameplay.tutorialHints = e.target.checked;
                console.log('üí° Dicas do tutorial alteradas para:', e.target.checked);
                this.applyGameplaySettings();
            });
        }
    }
    
    setupControlsSettings() {
        // Sensibilidade da c√¢mera
        const cameraSensitivity = document.getElementById('camera-sensitivity');
        const cameraSensitivityValue = document.getElementById('camera-sensitivity-value');
        if (cameraSensitivity && cameraSensitivityValue) {
            cameraSensitivity.addEventListener('input', (e) => {
                const value = parseFloat(e.target.value);
                cameraSensitivityValue.textContent = `${value.toFixed(1)}x`;
                this.settings.controls.cameraSensitivity = value;
                console.log('üéÆ Sensibilidade da c√¢mera alterada para:', value);
                this.applyControlsSettings();
            });
        }

        // Velocidade do zoom
        const zoomSpeed = document.getElementById('zoom-speed');
        const zoomSpeedValue = document.getElementById('zoom-speed-value');
        if (zoomSpeed && zoomSpeedValue) {
            zoomSpeed.addEventListener('input', (e) => {
                const value = parseFloat(e.target.value);
                zoomSpeedValue.textContent = `${value.toFixed(1)}x`;
                this.settings.controls.zoomSpeed = value;
                console.log('üîç Velocidade do zoom alterada para:', value);
                this.applyControlsSettings();
            });
        }
    }
    
    // ===== CONTROLE DE TELA =====
    showSettings() {
        console.log('‚öôÔ∏è Abrindo configura√ß√µes...');
        
        if (this.settingsScreen) {
            this.settingsScreen.classList.add('active');
        }
        
        // Atualizar valores na interface
        this.updateUI();
        
        // Tocar som
        if (window.AudioManager) {
            AudioManager.playSound('sfx_click');
        }
    }
    
    closeSettings() {
        console.log('‚öôÔ∏è Fechando configura√ß√µes...');

        if (this.settingsScreen) {
            this.settingsScreen.classList.remove('active');
        }

        // Retornar ao menu principal
        if (typeof showScreen === 'function') {
            showScreen('main-menu');
        } else {
            // Fallback manual
            document.querySelectorAll('.screen').forEach(screen => {
                screen.classList.remove('active');
            });
            const mainMenu = document.getElementById('main-menu');
            if (mainMenu) {
                mainMenu.classList.add('active');
            }
        }

        // Tocar som
        if (window.AudioManager) {
            AudioManager.playSound('sfx_click');
        }
    }
    
    isSettingsOpen() {
        return this.settingsScreen && this.settingsScreen.classList.contains('active');
    }
    
    // ===== ATUALIZA√á√ÉO DA UI =====
    updateUI() {
        // Atualizar controles de √°udio
        this.updateElement('master-volume', this.settings.audio.masterVolume);
        this.updateElement('master-volume-value', `${this.settings.audio.masterVolume}%`, 'textContent');
        this.updateElement('music-volume', this.settings.audio.musicVolume);
        this.updateElement('music-volume-value', `${this.settings.audio.musicVolume}%`, 'textContent');
        this.updateElement('sfx-volume', this.settings.audio.sfxVolume);
        this.updateElement('sfx-volume-value', `${this.settings.audio.sfxVolume}%`, 'textContent');
        
        // Atualizar controles de gr√°ficos
        this.updateElement('graphics-quality', this.settings.graphics.quality);
        this.updateElement('antialiasing', this.settings.graphics.antialiasing, 'checked');
        this.updateElement('shadows', this.settings.graphics.shadows, 'checked');
        
        // Atualizar controles de gameplay
        this.updateElement('difficulty', this.settings.gameplay.difficulty);
        this.updateElement('auto-save', this.settings.gameplay.autoSave, 'checked');
        this.updateElement('tutorial-hints', this.settings.gameplay.tutorialHints, 'checked');
        
        // Atualizar controles de c√¢mera
        this.updateElement('camera-sensitivity', this.settings.controls.cameraSensitivity);
        this.updateElement('camera-sensitivity-value', `${this.settings.controls.cameraSensitivity.toFixed(1)}x`);
        this.updateElement('zoom-speed', this.settings.controls.zoomSpeed);
        this.updateElement('zoom-speed-value', `${this.settings.controls.zoomSpeed.toFixed(1)}x`);
    }
    
    updateElement(id, value, property = 'value') {
        const element = document.getElementById(id);
        if (element) {
            if (property === 'checked') {
                element.checked = value;
            } else if (property === 'textContent') {
                element.textContent = value;
            } else {
                element.value = value;
            }
        }
    }
    
    // ===== APLICA√á√ÉO DE CONFIGURA√á√ïES =====
    applyAudioSettings() {
        console.log('üîä Aplicando configura√ß√µes de √°udio...', this.settings.audio);

        if (typeof AudioManager !== 'undefined') {
            try {
                const audioManager = AudioManager.getInstance();
                console.log('üîä AudioManager encontrado, aplicando volumes...');

                // Aplicar volumes (converter de 0-100 para 0-1)
                audioManager.setMasterVolume(this.settings.audio.masterVolume / 100);
                audioManager.setMusicVolume(this.settings.audio.musicVolume / 100);
                audioManager.setSfxVolume(this.settings.audio.sfxVolume / 100);

                console.log('‚úÖ Configura√ß√µes de √°udio aplicadas:', {
                    master: audioManager.masterVolume,
                    music: audioManager.musicVolume,
                    sfx: audioManager.sfxVolume
                });
            } catch (error) {
                console.error('‚ùå Erro ao aplicar configura√ß√µes de √°udio:', error);
            }
        } else {
            console.warn('‚ö†Ô∏è AudioManager n√£o encontrado');
        }
    }
    
    applyGraphicsSettings() {
        console.log('üé® Aplicando configura√ß√µes gr√°ficas...', this.settings.graphics);

        if (window.gameManager && window.gameManager.scene && window.gameManager.engine) {
            const scene = window.gameManager.scene;
            const engine = window.gameManager.engine;

            try {
                // Aplicar qualidade gr√°fica
                this.applyQualitySettings(scene, engine);

                // Aplicar configura√ß√µes de sombras
                this.applyShadowSettings(scene);

                // Anti-aliasing (requer reinicializa√ß√£o do engine)
                const currentAntialias = engine.getCreationOptions().antialias;
                if (this.settings.graphics.antialiasing !== currentAntialias) {
                    console.log('‚öôÔ∏è Anti-aliasing alterado - ser√° aplicado na pr√≥xima inicializa√ß√£o');
                    // Salvar configura√ß√£o para pr√≥xima inicializa√ß√£o
                    if (typeof GAME_CONFIG !== 'undefined') {
                        GAME_CONFIG.canvas.antialias = this.settings.graphics.antialiasing;
                    }
                }

                console.log('‚úÖ Configura√ß√µes gr√°ficas aplicadas');
            } catch (error) {
                console.error('‚ùå Erro ao aplicar configura√ß√µes gr√°ficas:', error);
            }
        } else {
            console.warn('‚ö†Ô∏è GameManager, scene ou engine n√£o encontrados');
        }
    }

    applyQualitySettings(scene, engine) {
        const quality = this.settings.graphics.quality;
        console.log('üé® Aplicando qualidade gr√°fica:', quality);

        // Configura√ß√µes baseadas na qualidade
        let renderTargetSize, shadowMapSize, particleCount, lightIntensity;

        switch (quality) {
            case 'low':
                renderTargetSize = 512;
                shadowMapSize = 512;
                particleCount = 0.5;
                lightIntensity = 0.8;
                break;
            case 'medium':
                renderTargetSize = 1024;
                shadowMapSize = 1024;
                particleCount = 1.0;
                lightIntensity = 1.0;
                break;
            case 'high':
                renderTargetSize = 2048;
                shadowMapSize = 2048;
                particleCount = 1.5;
                lightIntensity = 1.2;
                break;
            default:
                renderTargetSize = 1024;
                shadowMapSize = 1024;
                particleCount = 1.0;
                lightIntensity = 1.0;
        }

        // Aplicar configura√ß√µes de sombra baseadas na qualidade
        if (window.gameManager.shadowGenerator) {
            window.gameManager.shadowGenerator.mapSize = shadowMapSize;
            console.log('üé® Tamanho do mapa de sombras definido para:', shadowMapSize);
        }

        // Ajustar intensidade das luzes
        const lights = scene.lights;
        lights.forEach(light => {
            if (light.name !== 'cityHallLight') { // N√£o alterar luzes especiais
                const originalIntensity = light._originalIntensity || light.intensity;
                light._originalIntensity = originalIntensity;
                light.intensity = originalIntensity * lightIntensity;
            }
        });

        console.log('üé® Qualidade aplicada - Sombras:', shadowMapSize, 'Luzes:', lightIntensity);
    }

    applyShadowSettings(scene) {
        const shadowsEnabled = this.settings.graphics.shadows;
        console.log('üåë Aplicando configura√ß√µes de sombras:', shadowsEnabled);

        if (window.gameManager.shadowGenerator) {
            const shadowGenerator = window.gameManager.shadowGenerator;

            if (shadowsEnabled) {
                // Ativar sombras
                shadowGenerator.getShadowMap().renderList = shadowGenerator.getShadowMap().renderList || [];

                // Encontrar todos os meshes que devem projetar sombras
                scene.meshes.forEach(mesh => {
                    if (mesh.name.includes('building_') || mesh.name.includes('structure_')) {
                        shadowGenerator.addShadowCaster(mesh);
                    }
                });

                console.log('‚úÖ Sombras ativadas');
            } else {
                // Desativar sombras
                shadowGenerator.getShadowMap().renderList = [];
                console.log('‚ùå Sombras desativadas');
            }
        }
    }
    
    applyGameplaySettings() {
        console.log('üéÆ Aplicando configura√ß√µes de gameplay...', this.settings.gameplay);

        try {
            // Auto-save
            if (typeof GAME_CONFIG !== 'undefined') {
                if (this.settings.gameplay.autoSave) {
                    GAME_CONFIG.gameplay.autoSaveInterval = 30000; // 30 segundos
                    console.log('‚úÖ Auto-save ativado (30s)');
                } else {
                    GAME_CONFIG.gameplay.autoSaveInterval = Number.MAX_SAFE_INTEGER; // Desativar
                    console.log('‚ùå Auto-save desativado');
                }
            }

            // Dificuldade
            if (window.gameManager && window.gameManager.eventSystem) {
                let difficultyMultiplier = 1.0;
                switch (this.settings.gameplay.difficulty) {
                    case 'easy':
                        difficultyMultiplier = 0.7;
                        break;
                    case 'normal':
                        difficultyMultiplier = 1.0;
                        break;
                    case 'hard':
                        difficultyMultiplier = 1.5;
                        break;
                }
                window.gameManager.eventSystem.setDifficulty(difficultyMultiplier);
                console.log(`üéÆ Dificuldade definida: ${this.settings.gameplay.difficulty} (${difficultyMultiplier}x)`);
            }

            // Dicas do tutorial
            if (window.gameManager && window.gameManager.tutorialManager) {
                window.gameManager.tutorialManager.showHints = this.settings.gameplay.tutorialHints;
                console.log(`üí° Dicas do tutorial: ${this.settings.gameplay.tutorialHints ? 'ativadas' : 'desativadas'}`);
            }

            console.log('‚úÖ Configura√ß√µes de gameplay aplicadas');
        } catch (error) {
            console.error('‚ùå Erro ao aplicar configura√ß√µes de gameplay:', error);
        }
    }
    
    applyControlsSettings() {
        console.log('üéÆ Aplicando configura√ß√µes de controles...', this.settings.controls);

        try {
            if (window.gameManager && window.gameManager.camera) {
                const camera = window.gameManager.camera;

                // Aplicar sensibilidade da c√¢mera
                // Valores menores = mais sens√≠vel, valores maiores = menos sens√≠vel
                const baseSensitivity = 1000;
                const sensitivityMultiplier = 1 / this.settings.controls.cameraSensitivity;

                camera.angularSensibilityX = baseSensitivity * sensitivityMultiplier;
                camera.angularSensibilityY = baseSensitivity * sensitivityMultiplier;

                console.log(`üéÆ Sensibilidade da c√¢mera aplicada: ${this.settings.controls.cameraSensitivity}x (${camera.angularSensibilityX})`);

                // Aplicar velocidade do zoom
                // Valores menores = zoom mais r√°pido, valores maiores = zoom mais lento
                const baseZoomSpeed = 50;
                const zoomMultiplier = 1 / this.settings.controls.zoomSpeed;

                camera.wheelPrecision = baseZoomSpeed * zoomMultiplier;

                console.log(`üîç Velocidade do zoom aplicada: ${this.settings.controls.zoomSpeed}x (${camera.wheelPrecision})`);

                // Aplicar velocidade de movimento WASD
                if (window.gameManager.cameraControls) {
                    const baseMovementSpeed = 0.5;
                    window.gameManager.cameraControls.speed = baseMovementSpeed * this.settings.controls.cameraSensitivity;

                    console.log(`üö∂ Velocidade de movimento WASD aplicada: ${window.gameManager.cameraControls.speed}`);
                }

                console.log('‚úÖ Configura√ß√µes de controles aplicadas');
            } else {
                console.warn('‚ö†Ô∏è GameManager ou c√¢mera n√£o encontrados');
            }
        } catch (error) {
            console.error('‚ùå Erro ao aplicar configura√ß√µes de controles:', error);
        }
    }
    
    // ===== PERSIST√äNCIA =====
    saveSettings() {
        try {
            localStorage.setItem('guardiao_agua_settings', JSON.stringify(this.settings));
            
            // Aplicar todas as configura√ß√µes
            this.applyAudioSettings();
            this.applyGraphicsSettings();
            this.applyGameplaySettings();
            this.applyControlsSettings();
            
            console.log('‚úÖ Configura√ß√µes salvas');
            
            // Mostrar feedback
            this.showSaveConfirmation();
            
        } catch (error) {
            console.error('‚ùå Erro ao salvar configura√ß√µes:', error);
            alert('Erro ao salvar configura√ß√µes!');
        }
    }
    
    loadSettings() {
        try {
            const saved = localStorage.getItem('guardiao_agua_settings');
            if (saved) {
                const loadedSettings = JSON.parse(saved);
                this.settings = this.mergeSettings(this.defaultSettings, loadedSettings);
                console.log('‚úÖ Configura√ß√µes carregadas:', this.settings);

                // Aplicar configura√ß√µes carregadas com delay para garantir que os sistemas estejam prontos
                setTimeout(() => {
                    this.applyAudioSettings();
                    this.applyGraphicsSettings();
                    this.applyGameplaySettings();
                    this.applyControlsSettings();
                }, 100);
            } else {
                console.log('üìù Nenhuma configura√ß√£o salva encontrada, usando padr√µes');
                // Aplicar configura√ß√µes padr√£o
                setTimeout(() => {
                    this.applyAudioSettings();
                    this.applyGraphicsSettings();
                    this.applyGameplaySettings();
                    this.applyControlsSettings();
                }, 100);
            }
        } catch (error) {
            console.warn('‚ö†Ô∏è Erro ao carregar configura√ß√µes, usando padr√µes:', error);
            this.settings = { ...this.defaultSettings };
        }
    }
    
    resetToDefaults() {
        if (confirm('Tem certeza que deseja restaurar todas as configura√ß√µes para os valores padr√£o?')) {
            this.settings = JSON.parse(JSON.stringify(this.defaultSettings));
            this.updateUI();
            this.saveSettings();
            
            console.log('üîÑ Configura√ß√µes restauradas para padr√£o');
        }
    }
    
    mergeSettings(defaults, loaded) {
        const merged = JSON.parse(JSON.stringify(defaults));
        
        for (const category in loaded) {
            if (merged[category]) {
                for (const setting in loaded[category]) {
                    if (merged[category].hasOwnProperty(setting)) {
                        merged[category][setting] = loaded[category][setting];
                    }
                }
            }
        }
        
        return merged;
    }
    
    showSaveConfirmation() {
        // Criar elemento de confirma√ß√£o tempor√°rio
        const confirmation = document.createElement('div');
        confirmation.className = 'save-confirmation';
        confirmation.innerHTML = '‚úÖ Configura√ß√µes salvas!';
        confirmation.style.cssText = `
            position: fixed;
            top: 20px;
            right: 20px;
            background: #27ae60;
            color: white;
            padding: 1rem 2rem;
            border-radius: 8px;
            z-index: 10000;
            animation: slideIn 0.3s ease-out;
        `;
        
        document.body.appendChild(confirmation);
        
        // Remover ap√≥s 3 segundos
        setTimeout(() => {
            confirmation.remove();
        }, 3000);
    }
    
    // ===== GETTERS =====
    getSettings() {
        return { ...this.settings };
    }
    
    getSetting(category, key) {
        return this.settings[category] && this.settings[category][key];
    }
    
    // ===== CLEANUP =====
    dispose() {
        console.log('üóëÔ∏è SettingsManager disposed');
    }
}

console.log('‚öôÔ∏è SettingsManager carregado');
