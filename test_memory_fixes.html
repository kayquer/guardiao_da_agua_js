<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teste de CorreÃ§Ãµes de MemÃ³ria - GuardiÃ£o da Ãgua</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f0f0f0;
        }
        .test-container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .test-button {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        .test-button:hover {
            background: #45a049;
        }
        .test-button.danger {
            background: #f44336;
        }
        .test-button.danger:hover {
            background: #da190b;
        }
        .memory-info {
            background: #e8f5e8;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
            font-family: monospace;
        }
        .log-output {
            background: #f5f5f5;
            border: 1px solid #ddd;
            padding: 10px;
            height: 200px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <h1>ğŸ§ª Teste de CorreÃ§Ãµes de MemÃ³ria - GuardiÃ£o da Ãgua</h1>
    
    <div class="test-container">
        <h2>ğŸ“Š InformaÃ§Ãµes de MemÃ³ria</h2>
        <div id="memoryInfo" class="memory-info">
            Carregando informaÃ§Ãµes de memÃ³ria...
        </div>
        <button class="test-button" onclick="updateMemoryInfo()">ğŸ”„ Atualizar</button>
    </div>
    
    <div class="test-container">
        <h2>ğŸ§ª Testes de Stress</h2>
        <p>Execute estes testes para verificar se os vazamentos de memÃ³ria foram corrigidos:</p>
        
        <button class="test-button" onclick="runMemoryStressTest()">
            ğŸ—ï¸ Teste de Stress (20 EdifÃ­cios)
        </button>
        
        <button class="test-button" onclick="runBuildingCycleTest()">
            ğŸ”„ Teste de Ciclo (Construir/Demolir)
        </button>

        <button class="test-button" onclick="runRapidPlacementTest()">
            âš¡ Teste de ColocaÃ§Ã£o RÃ¡pida
        </button>

        <button class="test-button" onclick="testResourceUpdates()">
            ğŸ’§ Teste de Recursos
        </button>

        <button class="test-button" onclick="testBuildingPlacement()">
            ğŸ—ï¸ Teste de ColocaÃ§Ã£o
        </button>

        <button class="test-button" onclick="testElectricitySystem()">
            âš¡ Teste de Eletricidade
        </button>

        <button class="test-button" onclick="testCooldownSystem()">
            â±ï¸ Teste de Cooldown
        </button>

        <button class="test-button" onclick="testBudgetSystem()">
            ğŸ’° Teste de OrÃ§amento
        </button>

        <button class="test-button" onclick="testConstructionTimer()">
            ğŸš§ Teste de ConstruÃ§Ã£o
        </button>

        <button class="test-button" onclick="testWaterStorage()">
            ğŸ’§ Teste de Armazenamento
        </button>

        <button class="test-button" onclick="testResourcePanels()">
            ğŸ“Š Teste de PainÃ©is
        </button>

        <button class="test-button danger" onclick="clearAllBuildings()">
            ğŸ—‘ï¸ Limpar Todos os EdifÃ­cios
        </button>

        <button class="test-button" onclick="forceGarbageCollection()">
            ğŸ§¹ ForÃ§ar Garbage Collection
        </button>
    </div>
    
    <div class="test-container">
        <h2>ğŸ“ Log de Testes</h2>
        <div id="logOutput" class="log-output"></div>
        <button class="test-button" onclick="clearLog()">ğŸ§¹ Limpar Log</button>
    </div>
    
    <div class="test-container">
        <h2>âœ… VerificaÃ§Ãµes Implementadas</h2>
        <ul>
            <li>âœ… <strong>CRÃTICO - Sistema de Eletricidade:</strong> Corrigido erro "Cannot read properties of undefined" em addElectricityConsumption</li>
            <li>âœ… <strong>CRÃTICO - Sistema de OrÃ§amento:</strong> Implementada deduÃ§Ã£o automÃ¡tica de custos quando edifÃ­cios sÃ£o construÃ­dos</li>
            <li>âœ… <strong>Sistema de ConstruÃ§Ã£o com Timer:</strong> EdifÃ­cios agora tÃªm tempo de construÃ§Ã£o baseado no custo com indicadores visuais 3D</li>
            <li>âœ… <strong>GestÃ£o de Armazenamento de Ãgua:</strong> Sistema de capacidade limitada com formato "usado/mÃ¡ximo" (ex: 150/300L)</li>
            <li>âœ… <strong>PainÃ©is Detalhados de Recursos:</strong> Clique nos contadores para ver detalhes completos de Ã¡gua, orÃ§amento, energia e satisfaÃ§Ã£o</li>
            <li>âœ… <strong>Sistema de Cooldown:</strong> Implementado delay de 500ms entre construÃ§Ãµes para prevenir memory leaks</li>
            <li>âœ… <strong>Terreno Elevado:</strong> Colinas agora sÃ£o visualmente mais altas e menos frequentes (15-20%)</li>
            <li>âœ… <strong>Feedback de ConstruÃ§Ã£o:</strong> Mensagens user-friendly em portuguÃªs substituem logs de console</li>
            <li>âœ… <strong>Painel de Requisitos:</strong> Sidebar mostra requisitos de terreno com Ã­cones e cores</li>
            <li>âœ… <strong>CorreÃ§Ã£o de Tipos de Terreno:</strong> Terrenos agora retornam 'grassland', 'lowland', 'hill' compatÃ­veis com requisitos de edifÃ­cios</li>
            <li>âœ… <strong>Sistema de Fila de Disposal:</strong> Previne race conditions durante colocaÃ§Ã£o rÃ¡pida de edifÃ­cios</li>
            <li>âœ… <strong>Rastreamento de Texturas DinÃ¢micas:</strong> Texturas sÃ£o reutilizadas e dispostas corretamente</li>
            <li>âœ… <strong>Limpeza de Sombras:</strong> Meshes de sombra sÃ£o rastreados e dispostos</li>
            <li>âœ… <strong>Limpeza de ConexÃµes:</strong> ConexÃµes de terreno sÃ£o rastreadas e dispostas</li>
            <li>âœ… <strong>RemoÃ§Ã£o Segura de EdifÃ­cios:</strong> Todos os recursos associados sÃ£o limpos</li>
            <li>âœ… <strong>Posicionamento Corrigido:</strong> EdifÃ­cios agora se alinham corretamente ao terreno</li>
            <li>âœ… <strong>Ãgua Melhorada:</strong> Efeitos de profundidade e lagos maiores</li>
            <li>âœ… <strong>Sistema de DecoraÃ§Ã£o:</strong> VegetaÃ§Ã£o procedural que nÃ£o interfere com construÃ§Ã£o</li>
            <li>âœ… <strong>Monitoramento de MemÃ³ria:</strong> DetecÃ§Ã£o automÃ¡tica de vazamentos</li>
            <li>âœ… <strong>IntegraÃ§Ã£o ResourceManager:</strong> Recursos sÃ£o atualizados corretamente quando edifÃ­cios sÃ£o construÃ­dos/removidos</li>
        </ul>
    </div>

    <script>
        // Interceptar console.log para mostrar no log
        const originalLog = console.log;
        const originalWarn = console.warn;
        const originalError = console.error;
        
        function addToLog(message, type = 'log') {
            const logOutput = document.getElementById('logOutput');
            const timestamp = new Date().toLocaleTimeString();
            const color = type === 'error' ? 'red' : type === 'warn' ? 'orange' : 'black';
            logOutput.innerHTML += `<div style="color: ${color}">[${timestamp}] ${message}</div>`;
            logOutput.scrollTop = logOutput.scrollHeight;
        }
        
        console.log = function(...args) {
            originalLog.apply(console, args);
            addToLog(args.join(' '), 'log');
        };
        
        console.warn = function(...args) {
            originalWarn.apply(console, args);
            addToLog(args.join(' '), 'warn');
        };
        
        console.error = function(...args) {
            originalError.apply(console, args);
            addToLog(args.join(' '), 'error');
        };
        
        function updateMemoryInfo() {
            if (typeof getMemoryInfo === 'function') {
                const info = getMemoryInfo();
                const heapMB = (info.heapUsed / 1024 / 1024).toFixed(2);
                const totalMB = (info.heapTotal / 1024 / 1024).toFixed(2);
                
                document.getElementById('memoryInfo').innerHTML = `
                    <strong>Heap Usado:</strong> ${heapMB} MB<br>
                    <strong>Heap Total:</strong> ${totalMB} MB<br>
                    <strong>EdifÃ­cios:</strong> ${info.buildingCount}<br>
                    <strong>Meshes:</strong> ${info.meshCount}<br>
                    <strong>Texturas:</strong> ${info.textureCount}<br>
                    <strong>Materiais:</strong> ${info.materialCount}
                `;
            } else {
                document.getElementById('memoryInfo').innerHTML = 'Jogo nÃ£o carregado ainda. Aguarde...';
            }
        }
        
        function runMemoryStressTest() {
            if (typeof runMemoryTest === 'function') {
                console.log('ğŸ§ª Iniciando teste de stress de memÃ³ria...');
                runMemoryTest();
            } else {
                console.error('âŒ FunÃ§Ã£o runMemoryTest nÃ£o disponÃ­vel. Carregue o jogo primeiro.');
            }
        }

        function runRapidPlacementTest() {
            if (typeof runRapidPlacementTest === 'function') {
                console.log('âš¡ Iniciando teste de colocaÃ§Ã£o rÃ¡pida...');
                runRapidPlacementTest();
            } else {
                console.error('âŒ FunÃ§Ã£o runRapidPlacementTest nÃ£o disponÃ­vel. Carregue o jogo primeiro.');
            }
        }

        function testResourceUpdates() {
            if (typeof testResourceUpdates === 'function') {
                console.log('ğŸ’§ Testando atualizaÃ§Ãµes de recursos...');
                testResourceUpdates();
            } else {
                console.error('âŒ FunÃ§Ã£o testResourceUpdates nÃ£o disponÃ­vel. Carregue o jogo primeiro.');
            }
        }

        function testBuildingPlacement() {
            if (typeof testBuildingPlacement === 'function') {
                console.log('ğŸ—ï¸ Testando colocaÃ§Ã£o de edifÃ­cios...');
                testBuildingPlacement();
            } else {
                console.error('âŒ FunÃ§Ã£o testBuildingPlacement nÃ£o disponÃ­vel. Carregue o jogo primeiro.');
            }
        }

        function testElectricitySystem() {
            console.log('âš¡ Testando sistema de eletricidade...');

            if (typeof gameManager === 'undefined' || !gameManager.buildingSystem) {
                console.error('âŒ GameManager nÃ£o disponÃ­vel');
                return;
            }

            // Testar edifÃ­cios que consomem/produzem energia
            const electricityBuildings = [
                { type: 'water_pump', name: 'Bomba de Ãgua', expectConsumption: true },
                { type: 'treatment_plant', name: 'EstaÃ§Ã£o de Tratamento', expectConsumption: true },
                { type: 'hydroelectric_plant', name: 'HidrelÃ©trica', expectGeneration: true },
                { type: 'power_pole', name: 'Poste de Energia', expectTransmission: true }
            ];

            electricityBuildings.forEach((building, index) => {
                console.log(`\nâš¡ Teste ${index + 1}: ${building.name}`);

                try {
                    const x = 25 + index * 2;
                    const z = 25;

                    const placedBuilding = gameManager.buildingSystem.placeBuilding(x, z, building.type);
                    if (placedBuilding) {
                        console.log(`   âœ… ${building.name} construÃ­do sem erro de eletricidade`);

                        // Remover apÃ³s teste
                        setTimeout(() => {
                            gameManager.buildingSystem.removeBuilding(placedBuilding.id);
                            console.log(`   ğŸ—‘ï¸ ${building.name} removido`);
                        }, 1000);
                    } else {
                        console.error(`   âŒ Falha ao construir ${building.name}`);
                    }
                } catch (error) {
                    console.error(`   ğŸš¨ ERRO: ${error.message}`);
                }
            });

            console.log('\nâš¡ Teste de eletricidade concluÃ­do');
        }

        function testCooldownSystem() {
            console.log('â±ï¸ Testando sistema de cooldown...');

            if (typeof gameManager === 'undefined' || !gameManager.buildingSystem) {
                console.error('âŒ GameManager nÃ£o disponÃ­vel');
                return;
            }

            // Tentar construir rapidamente para testar cooldown
            let buildingCount = 0;
            const maxBuildings = 3;

            const rapidBuild = setInterval(() => {
                if (buildingCount >= maxBuildings) {
                    clearInterval(rapidBuild);
                    console.log('â±ï¸ Teste de cooldown concluÃ­do');
                    return;
                }

                const x = 20 + buildingCount;
                const z = 20;

                console.log(`â±ï¸ Tentativa ${buildingCount + 1}: Construindo casa em (${x}, ${z})`);

                const building = gameManager.buildingSystem.placeBuilding(x, z, 'house');
                if (building) {
                    console.log(`   âœ… Casa ${buildingCount + 1} construÃ­da`);
                } else {
                    console.log(`   â±ï¸ ConstruÃ§Ã£o bloqueada por cooldown (esperado)`);
                }

                buildingCount++;
            }, 200); // Tentar construir a cada 200ms (mais rÃ¡pido que o cooldown de 500ms)
        }
        
        function runBuildingCycleTest() {
            console.log('ğŸ”„ Iniciando teste de ciclo construir/demolir...');
            // Implementar teste de ciclo aqui
            if (typeof gameManager !== 'undefined' && gameManager.buildingSystem) {
                const buildingTypes = ['water_pump', 'house', 'treatment_plant'];
                let cycleCount = 0;
                
                function cycle() {
                    if (cycleCount >= 10) {
                        console.log('âœ… Teste de ciclo concluÃ­do');
                        return;
                    }
                    
                    // Construir edifÃ­cio
                    const x = Math.floor(Math.random() * 10) + 20;
                    const z = Math.floor(Math.random() * 10) + 20;
                    const type = buildingTypes[Math.floor(Math.random() * buildingTypes.length)];
                    
                    const building = gameManager.buildingSystem.placeBuilding(x, z, type);
                    if (building) {
                        console.log(`ğŸ—ï¸ Ciclo ${cycleCount + 1}: ConstruÃ­do ${type}`);
                        
                        // Demolir apÃ³s 1 segundo
                        setTimeout(() => {
                            gameManager.buildingSystem.removeBuilding(building.id);
                            console.log(`ğŸ—‘ï¸ Ciclo ${cycleCount + 1}: Demolido ${type}`);
                            cycleCount++;
                            
                            // PrÃ³ximo ciclo
                            setTimeout(cycle, 500);
                        }, 1000);
                    } else {
                        console.warn(`âš ï¸ NÃ£o foi possÃ­vel construir no ciclo ${cycleCount + 1}`);
                        cycleCount++;
                        setTimeout(cycle, 500);
                    }
                }
                
                cycle();
            } else {
                console.error('âŒ BuildingSystem nÃ£o disponÃ­vel');
            }
        }
        
        function clearAllBuildings() {
            if (typeof gameManager !== 'undefined' && gameManager.buildingSystem) {
                const buildingIds = Array.from(gameManager.buildingSystem.buildings.keys());
                buildingIds.forEach(id => {
                    gameManager.buildingSystem.removeBuilding(id);
                });
                console.log(`ğŸ—‘ï¸ ${buildingIds.length} edifÃ­cios removidos`);
            } else {
                console.error('âŒ BuildingSystem nÃ£o disponÃ­vel');
            }
        }
        
        function forceGarbageCollection() {
            if (window.gc) {
                window.gc();
                console.log('ğŸ§¹ Garbage collection forÃ§ado');
            } else {
                console.warn('âš ï¸ Garbage collection nÃ£o disponÃ­vel (execute com --expose-gc)');
            }
            updateMemoryInfo();
        }
        
        function clearLog() {
            document.getElementById('logOutput').innerHTML = '';
        }

        function testBudgetSystem() {
            console.log('ğŸ’° Testando sistema de orÃ§amento...');

            if (typeof gameManager === 'undefined' || !gameManager.buildingSystem || !gameManager.resourceManager) {
                console.error('âŒ Sistemas nÃ£o disponÃ­veis');
                return;
            }

            // Verificar orÃ§amento inicial
            const initialBudget = gameManager.resourceManager.resources.budget.current;
            console.log(`ğŸ’° OrÃ§amento inicial: R$ ${initialBudget.toLocaleString()}`);

            // Tentar construir edifÃ­cio caro
            const expensiveBuilding = gameManager.buildingSystem.placeBuilding(25, 25, 'treatment_plant');
            if (expensiveBuilding) {
                setTimeout(() => {
                    const newBudget = gameManager.resourceManager.resources.budget.current;
                    const cost = expensiveBuilding.config.cost;
                    const expectedBudget = initialBudget - cost;

                    console.log(`ğŸ’° OrÃ§amento apÃ³s construÃ§Ã£o: R$ ${newBudget.toLocaleString()}`);
                    console.log(`ğŸ’° Custo esperado: R$ ${cost.toLocaleString()}`);

                    if (Math.abs(newBudget - expectedBudget) < 1) {
                        console.log('âœ… Sistema de orÃ§amento funcionando corretamente');
                    } else {
                        console.error('âŒ Sistema de orÃ§amento com problemas');
                    }

                    // Limpar teste
                    gameManager.buildingSystem.removeBuilding(expensiveBuilding.id);
                }, 1000);
            } else {
                console.log('âš ï¸ NÃ£o foi possÃ­vel construir (pode ser falta de orÃ§amento)');
            }
        }

        function testConstructionTimer() {
            console.log('ğŸš§ Testando sistema de construÃ§Ã£o...');

            if (typeof gameManager === 'undefined' || !gameManager.buildingSystem) {
                console.error('âŒ BuildingSystem nÃ£o disponÃ­vel');
                return;
            }

            console.log('ğŸš§ Iniciando construÃ§Ã£o de casa...');
            const building = gameManager.buildingSystem.placeBuilding(20, 20, 'house');

            if (building) {
                console.log('ğŸš§ ConstruÃ§Ã£o iniciada - verificando progresso...');

                // Verificar progresso a cada segundo
                const progressCheck = setInterval(() => {
                    if (!building.underConstruction) {
                        console.log('âœ… ConstruÃ§Ã£o concluÃ­da!');
                        clearInterval(progressCheck);

                        // Limpar teste
                        setTimeout(() => {
                            gameManager.buildingSystem.removeBuilding(building.id);
                        }, 2000);
                    } else {
                        const elapsed = Date.now() - building.constructionStartTime;
                        const progress = Math.min(100, (elapsed / building.constructionDuration) * 100);
                        console.log(`ğŸš§ Progresso: ${Math.floor(progress)}%`);
                    }
                }, 1000);

                // Timeout de seguranÃ§a
                setTimeout(() => {
                    clearInterval(progressCheck);
                    console.log('ğŸš§ Teste de construÃ§Ã£o finalizado');
                }, 20000);
            } else {
                console.error('âŒ Falha ao iniciar construÃ§Ã£o');
            }
        }

        function testWaterStorage() {
            console.log('ğŸ’§ Testando sistema de armazenamento de Ã¡gua...');

            if (typeof gameManager === 'undefined' || !gameManager.resourceManager) {
                console.error('âŒ ResourceManager nÃ£o disponÃ­vel');
                return;
            }

            const initialWater = gameManager.resourceManager.resources.water;
            console.log(`ğŸ’§ Estado inicial - Atual: ${initialWater.current}L, Capacidade: ${initialWater.storage}L`);

            // Construir reservatÃ³rio (se existir)
            const reservoir = gameManager.buildingSystem.placeBuilding(22, 22, 'water_tank');
            if (reservoir) {
                setTimeout(() => {
                    const newWater = gameManager.resourceManager.resources.water;
                    console.log(`ğŸ’§ ApÃ³s reservatÃ³rio - Atual: ${newWater.current}L, Capacidade: ${newWater.storage}L`);

                    if (newWater.storage > initialWater.storage) {
                        console.log('âœ… Sistema de armazenamento funcionando');
                    } else {
                        console.warn('âš ï¸ Capacidade nÃ£o aumentou (verifique se water_tank tem waterStorage)');
                    }

                    // Limpar teste
                    gameManager.buildingSystem.removeBuilding(reservoir.id);
                }, 1000);
            } else {
                console.warn('âš ï¸ NÃ£o foi possÃ­vel construir reservatÃ³rio');
            }
        }

        function testResourcePanels() {
            console.log('ğŸ“Š Testando painÃ©is de recursos...');

            if (typeof gameManager === 'undefined' || !gameManager.uiManager) {
                console.error('âŒ UIManager nÃ£o disponÃ­vel');
                return;
            }

            console.log('ğŸ“Š Testando painel de Ã¡gua...');
            gameManager.uiManager.showWaterDetailsPanel();

            setTimeout(() => {
                console.log('ğŸ“Š Testando painel de orÃ§amento...');
                gameManager.uiManager.showBudgetDetailsPanel();

                setTimeout(() => {
                    console.log('ğŸ“Š Testando painel de energia...');
                    gameManager.uiManager.showEnergyDetailsPanel();

                    setTimeout(() => {
                        console.log('ğŸ“Š Testando painel de satisfaÃ§Ã£o...');
                        gameManager.uiManager.showSatisfactionDetailsPanel();

                        console.log('âœ… Todos os painÃ©is testados');
                    }, 1000);
                }, 1000);
            }, 1000);
        }

        // Atualizar informaÃ§Ãµes de memÃ³ria a cada 5 segundos
        setInterval(updateMemoryInfo, 5000);
        updateMemoryInfo();

        console.log('ğŸ§ª PÃ¡gina de teste carregada. Execute os testes para verificar as correÃ§Ãµes.');
    </script>
</body>
</html>
