<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teste de Corre√ß√µes de Mem√≥ria - Guardi√£o da √Ågua</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f0f0f0;
        }
        .test-container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .test-button {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        .test-button:hover {
            background: #45a049;
        }
        .test-button.danger {
            background: #f44336;
        }
        .test-button.danger:hover {
            background: #da190b;
        }
        .memory-info {
            background: #e8f5e8;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
            font-family: monospace;
        }
        .log-output {
            background: #f5f5f5;
            border: 1px solid #ddd;
            padding: 10px;
            height: 200px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <h1>üß™ Teste de Corre√ß√µes de Mem√≥ria - Guardi√£o da √Ågua</h1>
    
    <div class="test-container">
        <h2>üìä Informa√ß√µes de Mem√≥ria</h2>
        <div id="memoryInfo" class="memory-info">
            Carregando informa√ß√µes de mem√≥ria...
        </div>
        <button class="test-button" onclick="updateMemoryInfo()">üîÑ Atualizar</button>
    </div>
    
    <div class="test-container">
        <h2>üß™ Testes de Stress</h2>
        <p>Execute estes testes para verificar se os vazamentos de mem√≥ria foram corrigidos:</p>
        
        <button class="test-button" onclick="runMemoryStressTest()">
            üèóÔ∏è Teste de Stress (20 Edif√≠cios)
        </button>
        
        <button class="test-button" onclick="runBuildingCycleTest()">
            üîÑ Teste de Ciclo (Construir/Demolir)
        </button>

        <button class="test-button" onclick="runRapidPlacementTest()">
            ‚ö° Teste de Coloca√ß√£o R√°pida
        </button>

        <button class="test-button" onclick="testResourceUpdates()">
            üíß Teste de Recursos
        </button>

        <button class="test-button" onclick="testBuildingPlacement()">
            üèóÔ∏è Teste de Coloca√ß√£o
        </button>

        <button class="test-button danger" onclick="clearAllBuildings()">
            üóëÔ∏è Limpar Todos os Edif√≠cios
        </button>

        <button class="test-button" onclick="forceGarbageCollection()">
            üßπ For√ßar Garbage Collection
        </button>
    </div>
    
    <div class="test-container">
        <h2>üìù Log de Testes</h2>
        <div id="logOutput" class="log-output"></div>
        <button class="test-button" onclick="clearLog()">üßπ Limpar Log</button>
    </div>
    
    <div class="test-container">
        <h2>‚úÖ Verifica√ß√µes Implementadas</h2>
        <ul>
            <li>‚úÖ <strong>Corre√ß√£o de Tipos de Terreno:</strong> Terrenos agora retornam 'grassland', 'lowland', 'hill' compat√≠veis com requisitos de edif√≠cios</li>
            <li>‚úÖ <strong>Sistema de Fila de Disposal:</strong> Previne race conditions durante coloca√ß√£o r√°pida de edif√≠cios</li>
            <li>‚úÖ <strong>Rastreamento de Texturas Din√¢micas:</strong> Texturas s√£o reutilizadas e dispostas corretamente</li>
            <li>‚úÖ <strong>Limpeza de Sombras:</strong> Meshes de sombra s√£o rastreados e dispostos</li>
            <li>‚úÖ <strong>Limpeza de Conex√µes:</strong> Conex√µes de terreno s√£o rastreadas e dispostas</li>
            <li>‚úÖ <strong>Remo√ß√£o Segura de Edif√≠cios:</strong> Todos os recursos associados s√£o limpos</li>
            <li>‚úÖ <strong>Posicionamento Corrigido:</strong> Edif√≠cios agora se alinham corretamente ao terreno</li>
            <li>‚úÖ <strong>√Ågua Melhorada:</strong> Efeitos de profundidade e lagos maiores</li>
            <li>‚úÖ <strong>Sistema de Decora√ß√£o:</strong> Vegeta√ß√£o procedural que n√£o interfere com constru√ß√£o</li>
            <li>‚úÖ <strong>Monitoramento de Mem√≥ria:</strong> Detec√ß√£o autom√°tica de vazamentos</li>
            <li>‚úÖ <strong>Integra√ß√£o ResourceManager:</strong> Recursos s√£o atualizados corretamente quando edif√≠cios s√£o constru√≠dos/removidos</li>
            <li>‚úÖ <strong>Debug Detalhado:</strong> Logs detalhados para identificar problemas de coloca√ß√£o</li>
        </ul>
    </div>

    <script>
        // Interceptar console.log para mostrar no log
        const originalLog = console.log;
        const originalWarn = console.warn;
        const originalError = console.error;
        
        function addToLog(message, type = 'log') {
            const logOutput = document.getElementById('logOutput');
            const timestamp = new Date().toLocaleTimeString();
            const color = type === 'error' ? 'red' : type === 'warn' ? 'orange' : 'black';
            logOutput.innerHTML += `<div style="color: ${color}">[${timestamp}] ${message}</div>`;
            logOutput.scrollTop = logOutput.scrollHeight;
        }
        
        console.log = function(...args) {
            originalLog.apply(console, args);
            addToLog(args.join(' '), 'log');
        };
        
        console.warn = function(...args) {
            originalWarn.apply(console, args);
            addToLog(args.join(' '), 'warn');
        };
        
        console.error = function(...args) {
            originalError.apply(console, args);
            addToLog(args.join(' '), 'error');
        };
        
        function updateMemoryInfo() {
            if (typeof getMemoryInfo === 'function') {
                const info = getMemoryInfo();
                const heapMB = (info.heapUsed / 1024 / 1024).toFixed(2);
                const totalMB = (info.heapTotal / 1024 / 1024).toFixed(2);
                
                document.getElementById('memoryInfo').innerHTML = `
                    <strong>Heap Usado:</strong> ${heapMB} MB<br>
                    <strong>Heap Total:</strong> ${totalMB} MB<br>
                    <strong>Edif√≠cios:</strong> ${info.buildingCount}<br>
                    <strong>Meshes:</strong> ${info.meshCount}<br>
                    <strong>Texturas:</strong> ${info.textureCount}<br>
                    <strong>Materiais:</strong> ${info.materialCount}
                `;
            } else {
                document.getElementById('memoryInfo').innerHTML = 'Jogo n√£o carregado ainda. Aguarde...';
            }
        }
        
        function runMemoryStressTest() {
            if (typeof runMemoryTest === 'function') {
                console.log('üß™ Iniciando teste de stress de mem√≥ria...');
                runMemoryTest();
            } else {
                console.error('‚ùå Fun√ß√£o runMemoryTest n√£o dispon√≠vel. Carregue o jogo primeiro.');
            }
        }

        function runRapidPlacementTest() {
            if (typeof runRapidPlacementTest === 'function') {
                console.log('‚ö° Iniciando teste de coloca√ß√£o r√°pida...');
                runRapidPlacementTest();
            } else {
                console.error('‚ùå Fun√ß√£o runRapidPlacementTest n√£o dispon√≠vel. Carregue o jogo primeiro.');
            }
        }

        function testResourceUpdates() {
            if (typeof testResourceUpdates === 'function') {
                console.log('üíß Testando atualiza√ß√µes de recursos...');
                testResourceUpdates();
            } else {
                console.error('‚ùå Fun√ß√£o testResourceUpdates n√£o dispon√≠vel. Carregue o jogo primeiro.');
            }
        }

        function testBuildingPlacement() {
            if (typeof testBuildingPlacement === 'function') {
                console.log('üèóÔ∏è Testando coloca√ß√£o de edif√≠cios...');
                testBuildingPlacement();
            } else {
                console.error('‚ùå Fun√ß√£o testBuildingPlacement n√£o dispon√≠vel. Carregue o jogo primeiro.');
            }
        }
        
        function runBuildingCycleTest() {
            console.log('üîÑ Iniciando teste de ciclo construir/demolir...');
            // Implementar teste de ciclo aqui
            if (typeof gameManager !== 'undefined' && gameManager.buildingSystem) {
                const buildingTypes = ['water_pump', 'house', 'treatment_plant'];
                let cycleCount = 0;
                
                function cycle() {
                    if (cycleCount >= 10) {
                        console.log('‚úÖ Teste de ciclo conclu√≠do');
                        return;
                    }
                    
                    // Construir edif√≠cio
                    const x = Math.floor(Math.random() * 10) + 20;
                    const z = Math.floor(Math.random() * 10) + 20;
                    const type = buildingTypes[Math.floor(Math.random() * buildingTypes.length)];
                    
                    const building = gameManager.buildingSystem.placeBuilding(x, z, type);
                    if (building) {
                        console.log(`üèóÔ∏è Ciclo ${cycleCount + 1}: Constru√≠do ${type}`);
                        
                        // Demolir ap√≥s 1 segundo
                        setTimeout(() => {
                            gameManager.buildingSystem.removeBuilding(building.id);
                            console.log(`üóëÔ∏è Ciclo ${cycleCount + 1}: Demolido ${type}`);
                            cycleCount++;
                            
                            // Pr√≥ximo ciclo
                            setTimeout(cycle, 500);
                        }, 1000);
                    } else {
                        console.warn(`‚ö†Ô∏è N√£o foi poss√≠vel construir no ciclo ${cycleCount + 1}`);
                        cycleCount++;
                        setTimeout(cycle, 500);
                    }
                }
                
                cycle();
            } else {
                console.error('‚ùå BuildingSystem n√£o dispon√≠vel');
            }
        }
        
        function clearAllBuildings() {
            if (typeof gameManager !== 'undefined' && gameManager.buildingSystem) {
                const buildingIds = Array.from(gameManager.buildingSystem.buildings.keys());
                buildingIds.forEach(id => {
                    gameManager.buildingSystem.removeBuilding(id);
                });
                console.log(`üóëÔ∏è ${buildingIds.length} edif√≠cios removidos`);
            } else {
                console.error('‚ùå BuildingSystem n√£o dispon√≠vel');
            }
        }
        
        function forceGarbageCollection() {
            if (window.gc) {
                window.gc();
                console.log('üßπ Garbage collection for√ßado');
            } else {
                console.warn('‚ö†Ô∏è Garbage collection n√£o dispon√≠vel (execute com --expose-gc)');
            }
            updateMemoryInfo();
        }
        
        function clearLog() {
            document.getElementById('logOutput').innerHTML = '';
        }
        
        // Atualizar informa√ß√µes de mem√≥ria a cada 5 segundos
        setInterval(updateMemoryInfo, 5000);
        updateMemoryInfo();
        
        console.log('üß™ P√°gina de teste carregada. Execute os testes para verificar as corre√ß√µes.');
    </script>
</body>
</html>
