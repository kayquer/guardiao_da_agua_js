<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teste de Corre√ß√µes de Mem√≥ria - Guardi√£o da √Ågua</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f0f0f0;
        }
        .test-container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .test-button {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        .test-button:hover {
            background: #45a049;
        }
        .test-button.danger {
            background: #f44336;
        }
        .test-button.danger:hover {
            background: #da190b;
        }
        .memory-info {
            background: #e8f5e8;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
            font-family: monospace;
        }
        .log-output {
            background: #f5f5f5;
            border: 1px solid #ddd;
            padding: 10px;
            height: 200px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 12px;
        }
    </style>

    <!-- Babylon.js CDN -->
    <script src="https://cdn.babylonjs.com/babylon.js"></script>
    <script src="https://cdn.babylonjs.com/materialsLibrary/babylonjs.materials.min.js"></script>
    <script src="https://cdn.babylonjs.com/gui/babylon.gui.min.js"></script>
</head>
<body>
    <!-- Canvas oculto para o jogo -->
    <canvas id="test-canvas" style="display: none; width: 800px; height: 600px;"></canvas>
    <h1>üß™ Teste de Corre√ß√µes de Mem√≥ria - Guardi√£o da √Ågua</h1>
    
    <div class="test-container">
        <h2>üìä Informa√ß√µes de Mem√≥ria</h2>
        <div id="memoryInfo" class="memory-info">
            Carregando informa√ß√µes de mem√≥ria...
        </div>
        <button class="test-button" onclick="updateMemoryInfo()">üîÑ Atualizar</button>
    </div>
    
    <div class="test-container">
        <h2>üß™ Testes de Stress</h2>
        <p>Execute estes testes para verificar se os vazamentos de mem√≥ria foram corrigidos:</p>
        
        <button class="test-button" onclick="runMemoryStressTest()">
            üèóÔ∏è Teste de Stress (20 Edif√≠cios)
        </button>
        
        <button class="test-button" onclick="runBuildingCycleTest()">
            üîÑ Teste de Ciclo (Construir/Demolir)
        </button>

        <button class="test-button" onclick="runRapidPlacementTest()">
            ‚ö° Teste de Coloca√ß√£o R√°pida
        </button>

        <button class="test-button" onclick="testResourceUpdates()">
            üíß Teste de Recursos
        </button>

        <button class="test-button" onclick="testBuildingPlacement()">
            üèóÔ∏è Teste de Coloca√ß√£o
        </button>

        <button class="test-button" onclick="testElectricitySystem()">
            ‚ö° Teste de Eletricidade
        </button>

        <button class="test-button" onclick="testCooldownSystem()">
            ‚è±Ô∏è Teste de Cooldown
        </button>

        <button class="test-button" onclick="testBudgetSystem()">
            üí∞ Teste de Or√ßamento
        </button>

        <button class="test-button" onclick="testConstructionTimer()">
            üöß Teste de Constru√ß√£o
        </button>

        <button class="test-button" onclick="testWaterStorage()">
            üíß Teste de Armazenamento
        </button>

        <button class="test-button" onclick="testResourcePanels()">
            üìä Teste de Pain√©is
        </button>

        <button class="test-button danger" onclick="clearAllBuildings()">
            üóëÔ∏è Limpar Todos os Edif√≠cios
        </button>

        <button class="test-button" onclick="forceGarbageCollection()">
            üßπ For√ßar Garbage Collection
        </button>
    </div>
    
    <div class="test-container">
        <h2>üìù Log de Testes</h2>
        <div id="logOutput" class="log-output"></div>
        <button class="test-button" onclick="clearLog()">üßπ Limpar Log</button>
    </div>
    
    <div class="test-container">
        <h2>‚úÖ Verifica√ß√µes Implementadas</h2>
        <ul>
            <li>‚úÖ <strong>CR√çTICO - Sistema de Eletricidade:</strong> Corrigido erro "Cannot read properties of undefined" em addElectricityConsumption</li>
            <li>‚úÖ <strong>CR√çTICO - Sistema de Or√ßamento:</strong> Implementada dedu√ß√£o autom√°tica de custos quando edif√≠cios s√£o constru√≠dos</li>
            <li>‚úÖ <strong>Sistema de Constru√ß√£o com Timer:</strong> Edif√≠cios agora t√™m tempo de constru√ß√£o baseado no custo com indicadores visuais 3D</li>
            <li>‚úÖ <strong>Gest√£o de Armazenamento de √Ågua:</strong> Sistema de capacidade limitada com formato "usado/m√°ximo" (ex: 150/300L)</li>
            <li>‚úÖ <strong>Pain√©is Detalhados de Recursos:</strong> Clique nos contadores para ver detalhes completos de √°gua, or√ßamento, energia e satisfa√ß√£o</li>
            <li>‚úÖ <strong>Sistema de Cooldown:</strong> Implementado delay de 500ms entre constru√ß√µes para prevenir memory leaks</li>
            <li>‚úÖ <strong>Terreno Elevado:</strong> Colinas agora s√£o visualmente mais altas e menos frequentes (15-20%)</li>
            <li>‚úÖ <strong>Feedback de Constru√ß√£o:</strong> Mensagens user-friendly em portugu√™s substituem logs de console</li>
            <li>‚úÖ <strong>Painel de Requisitos:</strong> Sidebar mostra requisitos de terreno com √≠cones e cores</li>
            <li>‚úÖ <strong>Corre√ß√£o de Tipos de Terreno:</strong> Terrenos agora retornam 'grassland', 'lowland', 'hill' compat√≠veis com requisitos de edif√≠cios</li>
            <li>‚úÖ <strong>Sistema de Fila de Disposal:</strong> Previne race conditions durante coloca√ß√£o r√°pida de edif√≠cios</li>
            <li>‚úÖ <strong>Rastreamento de Texturas Din√¢micas:</strong> Texturas s√£o reutilizadas e dispostas corretamente</li>
            <li>‚úÖ <strong>Limpeza de Sombras:</strong> Meshes de sombra s√£o rastreados e dispostos</li>
            <li>‚úÖ <strong>Limpeza de Conex√µes:</strong> Conex√µes de terreno s√£o rastreadas e dispostas</li>
            <li>‚úÖ <strong>Remo√ß√£o Segura de Edif√≠cios:</strong> Todos os recursos associados s√£o limpos</li>
            <li>‚úÖ <strong>Posicionamento Corrigido:</strong> Edif√≠cios agora se alinham corretamente ao terreno</li>
            <li>‚úÖ <strong>√Ågua Melhorada:</strong> Efeitos de profundidade e lagos maiores</li>
            <li>‚úÖ <strong>Sistema de Decora√ß√£o:</strong> Vegeta√ß√£o procedural que n√£o interfere com constru√ß√£o</li>
            <li>‚úÖ <strong>Monitoramento de Mem√≥ria:</strong> Detec√ß√£o autom√°tica de vazamentos</li>
            <li>‚úÖ <strong>Integra√ß√£o ResourceManager:</strong> Recursos s√£o atualizados corretamente quando edif√≠cios s√£o constru√≠dos/removidos</li>
        </ul>
    </div>

    <script>
        // Interceptar console.log para mostrar no log
        const originalLog = console.log;
        const originalWarn = console.warn;
        const originalError = console.error;
        
        function addToLog(message, type = 'log') {
            const logOutput = document.getElementById('logOutput');
            const timestamp = new Date().toLocaleTimeString();
            const color = type === 'error' ? 'red' : type === 'warn' ? 'orange' : 'black';
            logOutput.innerHTML += `<div style="color: ${color}">[${timestamp}] ${message}</div>`;
            logOutput.scrollTop = logOutput.scrollHeight;
        }
        
        console.log = function(...args) {
            originalLog.apply(console, args);
            addToLog(args.join(' '), 'log');
        };
        
        console.warn = function(...args) {
            originalWarn.apply(console, args);
            addToLog(args.join(' '), 'warn');
        };
        
        console.error = function(...args) {
            originalError.apply(console, args);
            addToLog(args.join(' '), 'error');
        };
        
        function updateMemoryInfo() {
            if (typeof getMemoryInfo === 'function') {
                const info = getMemoryInfo();
                const heapMB = (info.heapUsed / 1024 / 1024).toFixed(2);
                const totalMB = (info.heapTotal / 1024 / 1024).toFixed(2);
                
                document.getElementById('memoryInfo').innerHTML = `
                    <strong>Heap Usado:</strong> ${heapMB} MB<br>
                    <strong>Heap Total:</strong> ${totalMB} MB<br>
                    <strong>Edif√≠cios:</strong> ${info.buildingCount}<br>
                    <strong>Meshes:</strong> ${info.meshCount}<br>
                    <strong>Texturas:</strong> ${info.textureCount}<br>
                    <strong>Materiais:</strong> ${info.materialCount}
                `;
            } else {
                document.getElementById('memoryInfo').innerHTML = 'Jogo n√£o carregado ainda. Aguarde...';
            }
        }
        
        function runMemoryStressTest() {
            if (typeof runMemoryTest === 'function') {
                console.log('üß™ Iniciando teste de stress de mem√≥ria...');
                runMemoryTest();
            } else {
                console.error('‚ùå Fun√ß√£o runMemoryTest n√£o dispon√≠vel. Carregue o jogo primeiro.');
            }
        }

        function runRapidPlacementTest() {
            if (typeof runRapidPlacementTest === 'function') {
                console.log('‚ö° Iniciando teste de coloca√ß√£o r√°pida...');
                runRapidPlacementTest();
            } else {
                console.error('‚ùå Fun√ß√£o runRapidPlacementTest n√£o dispon√≠vel. Carregue o jogo primeiro.');
            }
        }

        function testResourceUpdates() {
            if (typeof testResourceUpdates === 'function') {
                console.log('üíß Testando atualiza√ß√µes de recursos...');
                testResourceUpdates();
            } else {
                console.error('‚ùå Fun√ß√£o testResourceUpdates n√£o dispon√≠vel. Carregue o jogo primeiro.');
            }
        }

        function testBuildingPlacement() {
            if (typeof testBuildingPlacement === 'function') {
                console.log('üèóÔ∏è Testando coloca√ß√£o de edif√≠cios...');
                testBuildingPlacement();
            } else {
                console.error('‚ùå Fun√ß√£o testBuildingPlacement n√£o dispon√≠vel. Carregue o jogo primeiro.');
            }
        }

        function testElectricitySystem() {
            console.log('‚ö° Testando sistema de eletricidade...');

            if (typeof gameManager === 'undefined' || !gameManager.buildingSystem) {
                console.error('‚ùå GameManager n√£o dispon√≠vel');
                return;
            }

            // Testar edif√≠cios que consomem/produzem energia
            const electricityBuildings = [
                { type: 'water_pump', name: 'Bomba de √Ågua', expectConsumption: true },
                { type: 'treatment_plant', name: 'Esta√ß√£o de Tratamento', expectConsumption: true },
                { type: 'hydroelectric_plant', name: 'Hidrel√©trica', expectGeneration: true },
                { type: 'power_pole', name: 'Poste de Energia', expectTransmission: true }
            ];

            electricityBuildings.forEach((building, index) => {
                console.log(`\n‚ö° Teste ${index + 1}: ${building.name}`);

                try {
                    const x = 25 + index * 2;
                    const z = 25;

                    const placedBuilding = gameManager.buildingSystem.placeBuilding(x, z, building.type);
                    if (placedBuilding) {
                        console.log(`   ‚úÖ ${building.name} constru√≠do sem erro de eletricidade`);

                        // Remover ap√≥s teste
                        setTimeout(() => {
                            gameManager.buildingSystem.removeBuilding(placedBuilding.id);
                            console.log(`   üóëÔ∏è ${building.name} removido`);
                        }, 1000);
                    } else {
                        console.error(`   ‚ùå Falha ao construir ${building.name}`);
                    }
                } catch (error) {
                    console.error(`   üö® ERRO: ${error.message}`);
                }
            });

            console.log('\n‚ö° Teste de eletricidade conclu√≠do');
        }

        function testCooldownSystem() {
            console.log('‚è±Ô∏è Testando sistema de cooldown...');

            if (typeof gameManager === 'undefined' || !gameManager.buildingSystem) {
                console.error('‚ùå GameManager n√£o dispon√≠vel');
                return;
            }

            // Tentar construir rapidamente para testar cooldown
            let buildingCount = 0;
            const maxBuildings = 3;

            const rapidBuild = setInterval(() => {
                if (buildingCount >= maxBuildings) {
                    clearInterval(rapidBuild);
                    console.log('‚è±Ô∏è Teste de cooldown conclu√≠do');
                    return;
                }

                const x = 20 + buildingCount;
                const z = 20;

                console.log(`‚è±Ô∏è Tentativa ${buildingCount + 1}: Construindo casa em (${x}, ${z})`);

                const building = gameManager.buildingSystem.placeBuilding(x, z, 'house');
                if (building) {
                    console.log(`   ‚úÖ Casa ${buildingCount + 1} constru√≠da`);
                } else {
                    console.log(`   ‚è±Ô∏è Constru√ß√£o bloqueada por cooldown (esperado)`);
                }

                buildingCount++;
            }, 200); // Tentar construir a cada 200ms (mais r√°pido que o cooldown de 500ms)
        }
        
        function runBuildingCycleTest() {
            console.log('üîÑ Iniciando teste de ciclo construir/demolir...');
            // Implementar teste de ciclo aqui
            if (typeof gameManager !== 'undefined' && gameManager.buildingSystem) {
                const buildingTypes = ['water_pump', 'house', 'treatment_plant'];
                let cycleCount = 0;
                
                function cycle() {
                    if (cycleCount >= 10) {
                        console.log('‚úÖ Teste de ciclo conclu√≠do');
                        return;
                    }
                    
                    // Construir edif√≠cio
                    const x = Math.floor(Math.random() * 10) + 20;
                    const z = Math.floor(Math.random() * 10) + 20;
                    const type = buildingTypes[Math.floor(Math.random() * buildingTypes.length)];
                    
                    const building = gameManager.buildingSystem.placeBuilding(x, z, type);
                    if (building) {
                        console.log(`üèóÔ∏è Ciclo ${cycleCount + 1}: Constru√≠do ${type}`);
                        
                        // Demolir ap√≥s 1 segundo
                        setTimeout(() => {
                            gameManager.buildingSystem.removeBuilding(building.id);
                            console.log(`üóëÔ∏è Ciclo ${cycleCount + 1}: Demolido ${type}`);
                            cycleCount++;
                            
                            // Pr√≥ximo ciclo
                            setTimeout(cycle, 500);
                        }, 1000);
                    } else {
                        console.warn(`‚ö†Ô∏è N√£o foi poss√≠vel construir no ciclo ${cycleCount + 1}`);
                        cycleCount++;
                        setTimeout(cycle, 500);
                    }
                }
                
                cycle();
            } else {
                console.error('‚ùå BuildingSystem n√£o dispon√≠vel');
            }
        }
        
        function clearAllBuildings() {
            if (typeof gameManager !== 'undefined' && gameManager.buildingSystem) {
                const buildingIds = Array.from(gameManager.buildingSystem.buildings.keys());
                buildingIds.forEach(id => {
                    gameManager.buildingSystem.removeBuilding(id);
                });
                console.log(`üóëÔ∏è ${buildingIds.length} edif√≠cios removidos`);
            } else {
                console.error('‚ùå BuildingSystem n√£o dispon√≠vel');
            }
        }
        
        function forceGarbageCollection() {
            if (window.gc) {
                window.gc();
                console.log('üßπ Garbage collection for√ßado');
            } else {
                console.warn('‚ö†Ô∏è Garbage collection n√£o dispon√≠vel (execute com --expose-gc)');
            }
            updateMemoryInfo();
        }
        
        function clearLog() {
            document.getElementById('logOutput').innerHTML = '';
        }

        function testBudgetSystem() {
            console.log('üí∞ Testando sistema de or√ßamento...');

            if (typeof gameManager === 'undefined' || !gameManager.buildingSystem || !gameManager.resourceManager) {
                console.error('‚ùå Sistemas n√£o dispon√≠veis');
                return;
            }

            // Verificar or√ßamento inicial
            const initialBudget = gameManager.resourceManager.resources.budget.current;
            console.log(`üí∞ Or√ßamento inicial: R$ ${initialBudget.toLocaleString()}`);

            // Tentar construir edif√≠cio caro
            const expensiveBuilding = gameManager.buildingSystem.placeBuilding(25, 25, 'treatment_plant');
            if (expensiveBuilding) {
                setTimeout(() => {
                    const newBudget = gameManager.resourceManager.resources.budget.current;
                    const cost = expensiveBuilding.config.cost;
                    const expectedBudget = initialBudget - cost;

                    console.log(`üí∞ Or√ßamento ap√≥s constru√ß√£o: R$ ${newBudget.toLocaleString()}`);
                    console.log(`üí∞ Custo esperado: R$ ${cost.toLocaleString()}`);

                    if (Math.abs(newBudget - expectedBudget) < 1) {
                        console.log('‚úÖ Sistema de or√ßamento funcionando corretamente');
                    } else {
                        console.error('‚ùå Sistema de or√ßamento com problemas');
                    }

                    // Limpar teste
                    gameManager.buildingSystem.removeBuilding(expensiveBuilding.id);
                }, 1000);
            } else {
                console.log('‚ö†Ô∏è N√£o foi poss√≠vel construir (pode ser falta de or√ßamento)');
            }
        }

        function testConstructionTimer() {
            console.log('üöß Testando sistema de constru√ß√£o...');

            if (typeof gameManager === 'undefined' || !gameManager.buildingSystem) {
                console.error('‚ùå BuildingSystem n√£o dispon√≠vel');
                return;
            }

            console.log('üöß Iniciando constru√ß√£o de casa...');
            const building = gameManager.buildingSystem.placeBuilding(20, 20, 'house');

            if (building) {
                console.log('üöß Constru√ß√£o iniciada - verificando progresso...');

                // Verificar progresso a cada segundo
                const progressCheck = setInterval(() => {
                    if (!building.underConstruction) {
                        console.log('‚úÖ Constru√ß√£o conclu√≠da!');
                        clearInterval(progressCheck);

                        // Limpar teste
                        setTimeout(() => {
                            gameManager.buildingSystem.removeBuilding(building.id);
                        }, 2000);
                    } else {
                        const elapsed = Date.now() - building.constructionStartTime;
                        const progress = Math.min(100, (elapsed / building.constructionDuration) * 100);
                        console.log(`üöß Progresso: ${Math.floor(progress)}%`);
                    }
                }, 1000);

                // Timeout de seguran√ßa
                setTimeout(() => {
                    clearInterval(progressCheck);
                    console.log('üöß Teste de constru√ß√£o finalizado');
                }, 20000);
            } else {
                console.error('‚ùå Falha ao iniciar constru√ß√£o');
            }
        }

        function testWaterStorage() {
            console.log('üíß Testando sistema de armazenamento de √°gua...');

            if (typeof gameManager === 'undefined' || !gameManager.resourceManager) {
                console.error('‚ùå ResourceManager n√£o dispon√≠vel');
                return;
            }

            const initialWater = gameManager.resourceManager.resources.water;
            console.log(`üíß Estado inicial - Atual: ${initialWater.current}L, Capacidade: ${initialWater.storage}L`);

            // Construir reservat√≥rio (se existir)
            const reservoir = gameManager.buildingSystem.placeBuilding(22, 22, 'water_tank');
            if (reservoir) {
                setTimeout(() => {
                    const newWater = gameManager.resourceManager.resources.water;
                    console.log(`üíß Ap√≥s reservat√≥rio - Atual: ${newWater.current}L, Capacidade: ${newWater.storage}L`);

                    if (newWater.storage > initialWater.storage) {
                        console.log('‚úÖ Sistema de armazenamento funcionando');
                    } else {
                        console.warn('‚ö†Ô∏è Capacidade n√£o aumentou (verifique se water_tank tem waterStorage)');
                    }

                    // Limpar teste
                    gameManager.buildingSystem.removeBuilding(reservoir.id);
                }, 1000);
            } else {
                console.warn('‚ö†Ô∏è N√£o foi poss√≠vel construir reservat√≥rio');
            }
        }

        function testResourcePanels() {
            console.log('üìä Testando pain√©is de recursos...');

            if (typeof gameManager === 'undefined' || !gameManager.uiManager) {
                console.error('‚ùå UIManager n√£o dispon√≠vel');
                return;
            }

            console.log('üìä Testando painel de √°gua...');
            gameManager.uiManager.showWaterDetailsPanel();

            setTimeout(() => {
                console.log('üìä Testando painel de or√ßamento...');
                gameManager.uiManager.showBudgetDetailsPanel();

                setTimeout(() => {
                    console.log('üìä Testando painel de energia...');
                    gameManager.uiManager.showEnergyDetailsPanel();

                    setTimeout(() => {
                        console.log('üìä Testando painel de satisfa√ß√£o...');
                        gameManager.uiManager.showSatisfactionDetailsPanel();

                        console.log('‚úÖ Todos os pain√©is testados');
                    }, 1000);
                }, 1000);
            }, 1000);
        }

        // Atualizar informa√ß√µes de mem√≥ria a cada 5 segundos
        setInterval(updateMemoryInfo, 5000);
        updateMemoryInfo();

        console.log('üß™ P√°gina de teste carregada. Execute os testes para verificar as corre√ß√µes.');
    </script>

    <!-- Scripts do Jogo - Ordem correta de depend√™ncias -->
    <!-- Utilit√°rios primeiro -->
    <script src="js/utils/AssetLoader.js"></script>
    <script src="js/utils/AudioManager.js"></script>

    <!-- Core systems - ordem de depend√™ncia -->
    <script src="js/core/GridManager.js"></script>
    <script src="js/core/ResourceManager.js"></script>
    <script src="js/core/GameManager.js"></script>

    <!-- Game systems -->
    <script src="js/systems/BuildingSystem.js"></script>
    <script src="js/systems/CityLifeSystem.js"></script>
    <script src="js/systems/UIManager.js"></script>
    <script src="js/systems/QuestSystem.js"></script>
    <script src="js/systems/EventSystem.js"></script>
    <script src="js/systems/SaveSystem.js"></script>
    <script src="js/systems/TutorialManager.js"></script>
    <script src="js/systems/SettingsManager.js"></script>

    <!-- Main initialization -->
    <script src="js/main.js"></script>

    <!-- Test page initialization -->
    <script>
        // Aguardar carregamento completo e inicializar jogo para testes
        window.addEventListener('load', async function() {
            try {
                console.log('üéÆ Inicializando jogo para testes...');

                // Aguardar um pouco mais para garantir que todos os scripts carregaram
                await new Promise(resolve => setTimeout(resolve, 2000));

                // Verificar se todas as classes est√£o dispon√≠veis
                if (typeof GameManager === 'undefined') {
                    throw new Error('GameManager n√£o carregado');
                }

                if (typeof GAME_CONFIG === 'undefined') {
                    throw new Error('GAME_CONFIG n√£o carregado');
                }

                // Criar inst√¢ncia do GameManager
                window.gameManager = new GameManager();

                // Inicializar sistemas
                await gameManager.initializeSystems();

                console.log('‚úÖ Jogo inicializado para testes');
                updateMemoryInfo(); // Atualizar informa√ß√µes imediatamente

            } catch (error) {
                console.error('‚ùå Erro ao inicializar jogo para testes:', error);
                document.getElementById('memoryInfo').innerHTML = `
                    <span style="color: red;">Erro na inicializa√ß√£o: ${error.message}</span><br>
                    Verifique o console para mais detalhes.
                `;
            }
        });
    </script>
</body>
</html>
